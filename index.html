<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="On working with The Virtual Brain  : and some non virtual thoughts about Google Summer of Code 2014.">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>On working with The Virtual Brain </title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/quiuquio/tvb-framework">View on GitHub</a>

          <h1 id="project_title">On working with The Virtual Brain </h1>
          <h2 id="project_tagline">and some non virtual thoughts about Google Summer of Code 2014.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/quiuquio/tvb-framework/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/quiuquio/tvb-framework/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>
<a name="what-is-this-about" class="anchor" href="#what-is-this-about"><span class="octicon octicon-link"></span></a>What is this about?</h3>

<p>Hi all, my name is Robert Parcus and I'm a CS student
from UNIPG (Italy). I'm moving to Hong Kong this September to further my studies
and my plan for the Summer of 2014 was to participate in this year's <a href="https://www.google-melange.com/gsoc/homepage/google/gsoc2014">Google
Summer Of Code</a>.</p>

<p>Gladly, I was accepted as a student in this amazing project and here I would
like to spend a few words about the whole experience. Going from the application
phase up to the finishing days. I hope you will enjoy the journey as much as I
did.</p>

<h3>
<a name="the-application-phase" class="anchor" href="#the-application-phase"><span class="octicon octicon-link"></span></a>The Application Phase:</h3>

<p>After browsing the list of accepted organizations, I quick</p>

<h3>
<a name="volumetric-time-series-visualizer-for-tvb-and-updating-other-visualization-tools" class="anchor" href="#volumetric-time-series-visualizer-for-tvb-and-updating-other-visualization-tools"><span class="octicon octicon-link"></span></a>Volumetric Time series visualizer for TVB and updating other visualization tools</h3>

<p>This was the final title of my proposal. From the Google-melange website:</p>

<blockquote>
<p><strong>Organization:</strong> International Neuroinformatics Coordinating Facility</p>

<p><strong>Assigned mentors:</strong> Lia Domide, Paula Sanz-Leon</p>

<p><strong>Short description:</strong> The main goal of this proposal is to implement a time-
series visualizer for 4D data in TVB, which would enable users to work with
their functional MRI data directly from the browser. Then I will work on
rewriting some of the visualizers that are currently implemented using
MatplotLib and MPLH5, backed with web-friendly tools.</p>
</blockquote>

<p>The proposal itself was much bigger and specific than this. The whole
application phase was already a big challenge by itself. It was my first time
planning for  a project this big and I learned a lot during the process. A big
help came from my mentors who always had good suggestions ready for me and I
can't stress enough how much a good advice from your mentor can help you in a
tricky situation.</p>

<h3>
<a name="technical-aspects" class="anchor" href="#technical-aspects"><span class="octicon octicon-link"></span></a>Technical aspects</h3>

<p><img src="https://raw.githubusercontent.com/quiuquio/tvb-framework/gh-pages/images/tvbPost/first.png" alt="The Visulizer Prototype" title="The Visulizer Prototype"></p>

<p>We decided to work on an already implemented prototype. The basic features to
display the slices were already in place but the visualizer was missing its
playback  functionalities.</p>

<p>Also, since fMRI data can be huge, a buffering mechanism was necessary in order
to load the required information and display it as fast as possible on the
browser.</p>

<p>At first, I decided to give our visualizer a real user interface, so that I
could test it directly as a user would do, without having to rely only on the
console. The UI would also help display some information about the data being
visualized, like selected time point and coordinates. Moreover, I tried to
resize the quadrants and give each one of them a margin.</p>

<p>After playing around with the quadrants settings and using jQuery UI to create
the user interface I had something very basic, like this:
<img src="https://raw.githubusercontent.com/quiuquio/tvb-framework/gh-pages/images/tvbPost/second.png" alt="First UI" title="First UI"></p>

<p>Now, for the hard part, it was time to focus on the buffering and the playback
features.</p>

<p>My first attempt was to load everything in memory, but soon it was clear that
this was not a realistic approach. A compressed fMRI file can easily occupy
hundreds of Megabytes, hence loaded, uncompressed data could easily surpass the
Gigabyte mark.</p>

<p>For example, we had a 91x109x91 voxels test set and it was 177 frames long. This
makes for a floating point array with 159765333 elements.
Such a big javascript array is just an easy way to crash your browser.</p>

<p>On the other hand, a purely lazy approach was also a bad solution: To query for
a single frame, wait for the server to prepare it, receive the json data and
parse it was either too slow or an overall waste of bandwidth, because of the
overhead of requesting only one frame at a time. Also, even if AJAX calls can be
made asynchronously, the playback and UI would all freeze while waiting for the
parsing operations.</p>

<p>To avoid blocking the main thread we used webworkes for parsing the json. An in-
line wrapper was used so that we didn't need to use a separate file for the
webworker code.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">inlineWebWorkerWrapper</span><span class="p">(</span><span class="nx">workerBody</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">retBlob</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span>
            <span class="s1">'('</span><span class="p">,</span>
                <span class="nx">workerBody</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
            <span class="s1">')()'</span> <span class="p">],</span>
        <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">'application/javascript'</span> <span class="p">}</span>
        <span class="p">)</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="nx">retBlob</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>While the parsing function was similar to:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">parserBlob</span> <span class="o">=</span> <span class="nx">inlineWebWorkerWrapper</span><span class="p">(</span>
            <span class="kd">function</span><span class="p">(){</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">){</span>
                    <span class="c1">// Parse JSON, send it to main thread, close the worker</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                <span class="p">},</span> <span class="kc">false</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">);</span>

<span class="kd">function</span> <span class="nx">parseAsync</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">worker</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">json</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Worker</span> <span class="p">){</span>
        <span class="nx">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Worker</span><span class="p">(</span> <span class="nx">parserBlob</span> <span class="p">);</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s1">'message'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">){</span>
            <span class="nx">json</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="nx">callback</span><span class="p">(</span> <span class="nx">json</span> <span class="p">);</span>
        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
        <span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span> <span class="nx">json</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>It is important to remember that this approach <strong>will not</strong> speed up the parsing
itself (it may even delay it). Its only benefit is that the main thread will
never freeze while waiting for the parsing to happen and during playback this
is exactly what we need.</p>

<p>With the parsing problem solved, the next thing was buffering.</p>

<p>The visualizer checks the selected voxel and asynchronously queries the server
for batches of frames of the three visible planes only. If our data is composed
of n sized MRI "cubes", this approach reduces the spatial complexity of each
frame from O(n^3) to O(n^2).</p>

<p>If the user clicks the planes to navigate in space, we halt the buffering of
future frames and synchronously load the complete cube data for that time point.
A little delay was expected in this cases but we noticed that it consisted of a
negligible wait for average resolution data. As soon as the user stops picking,
we can resume playback again, together with the buffering of future data based
on the new selected voxel.</p>

<p>Coupled with the buffering system, a safety procedure was put in place 
to keep the memory footprint always under a certain threshold.</p>

<h3>
<a name="time-series-fragment-visualizer" class="anchor" href="#time-series-fragment-visualizer"><span class="octicon octicon-link"></span></a>Time Series Fragment Visualizer</h3>

<p>After the completion of the Volumetric Time Series Visualizer, the plan was to
work a little on many other visualizers on The Virtual Brain. Talking with my mentors
<a href="https://github.com/liadomide" class="user-mention">@liadomide</a> and <a href="https://github.com/paulsz" class="user-mention">@paulsz</a> we decided that if I could work on a complete</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">On working with The Virtual Brain  maintained by <a href="https://github.com/quiuquio">quiuquio</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
